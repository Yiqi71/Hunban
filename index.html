<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>魂蛋小原</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 400;
            margin: 0;
            overflow: hidden;
            position: relative;
            background-color: black;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            align-items: center;
        }

        menu {
            z-index: 10;
        }

        canvas {
            display: block;
            position: absolute;
            z-index: 1;
        }

        .buttons {
            position: absolute;
            /* top: 20px;
            left: 20px; */
            bottom: 5em;
            z-index: 10;
            display: flex;
            flex-direction: row;
        }

        .button {
            width: 120px;
            height: 60px;
            padding: 10px;
            /* border: solid 1px white; */
        }

        .buttons .button img {
            width: 120px;
            height: auto;
            z-index: 1;
            position: absolute;
        }

        /* 公共部分，所有屏幕都用 */
        .buttons .button button {
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 500;
            z-index: 10;
            position: absolute;
            width: 120px;
            height: 60px;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* 小屏（<= 430px）调整字体大小 */
        @media (max-width: 580px) {
            .button{
                width:100px;
                height:50px;
            }
            .buttons .button img{
                width:100px;
                height:auto;
            }
            .buttons .button button {
                font-size: 16px !important;
                width:100px;
                height:50px;
            }
        }

        /* 中屏以上 (> 430px) 调整字体大小 */
        @media (min-width: 581px) {
            .buttons .button button {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>

    <menu>
        <img alt="logo" src="assets/logo.png" width="100">
    </menu>
    <canvas id="xiaoyuan"></canvas>
    <div class="buttons">
        <div class="button">
            <button onclick="triggerAction('greet')">
                打招呼
            </button>
            <img src="assets/Asset 3.png" alt="button" width="120">
        </div>

        <div class="button">
            <img src="assets/Asset 3.png" alt="button" width="120">
            <button onclick="triggerAction('happy')">
                开心
            </button>
        </div>

        <div class="button">
            <img src="assets/Asset 3.png" alt="button" width="120">
            <button onclick="triggerAction('sad')">
                伤心
            </button>
        </div>

        <div class="button">
            <img src="assets/Asset 3.png" alt="button" width="120">
            <button onclick="triggerAction('think')">
                思考
            </button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        const canvas = document.getElementById("xiaoyuan");

        let scene, camera, renderer;
        let body, headGroup, head;
        let targetRotation = {
            groupX: 0,
            groupY: 0,
            groupZ: 0,
            headX: 0,
            headY: 0,
            headZ: 0
        };
        let isActionPlaying = false; // 控制是否可以press朝向
        let isPressing = false; // 是否按着
        let isReturning = false; // 是否正在归位中

        let returnStartTime = 0;
        let returnDuration = 500; // 归零时间 500ms

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let isTickling = false;
        let tickleStartTime = 0;
        let laughSound;

        let facePlane;
        const textureLoader = new THREE.TextureLoader();

        // 创建Plane
        function createFacePlane() {
            const faceTexture = textureLoader.load('assets/default.png');
            const faceMaterial = new THREE.MeshBasicMaterial({
                map: faceTexture,
                transparent: true,
                side: THREE.DoubleSide // 双面可见，防止旋转后消失
            });

            const faceGeometry = new THREE.PlaneGeometry(0.18, 0.1); // 宽高可以调整
            facePlane = new THREE.Mesh(faceGeometry, faceMaterial);

            facePlane.position.set(0, 0.15, 0.5); // 按头的位置微调
            head.add(facePlane); // 直接加在head上！
        }



        init();
        animate();

        // 预加载表情图片
        const faceTextures = {
            default: textureLoader.load('assets/default.png'),
            greet: textureLoader.load('assets/wink.png'),
            laugh: textureLoader.load('assets/laugh.png')
        };


        // 初始化xiaoyuan
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color("black");

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1, 3);

            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            // document.body.appendChild(renderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(1, 2, 3);
            scene.add(light);

            // fac959
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);

            const yellow = new THREE.AmbientLight(0xfac959, 0.1);
            scene.add(yellow);

            const loader = new THREE.GLTFLoader();

            loader.load('assets/hunban-body.glb', function (gltf) {
                body = gltf.scene;
                body.position.set(0, 0.5, 0);
                scene.add(body);
            });

            const headOffset = new THREE.Group();
            loader.load('assets/hunban-head.glb', function (gltf) {
                headGroup = new THREE.Group();
                head = gltf.scene;
                head.position.set(0, 0, 0);
                headGroup.position.set(0, 0.5, 0);
                headOffset.position.set(0, 0.6, 0);
                headGroup.add(headOffset);
                headOffset.add(head);
                scene.add(headGroup);

                console.log("head position in group:", head.position);
                createFacePlane();
            });


            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousedown', onPressStart);
            window.addEventListener('mouseup', onPressEnd);

        }

        // 适应窗口大小变化
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function smoothStep(progress) {
            return progress * progress * (3 - 2 * progress);
        }


        // xiaoyuan的动画循环
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001; // 当前时间，秒

            // if (!isActionPlaying && body) {
            if (body) {
                // ✨ 呼吸上下浮动
                const baseY = 0.5; // 身体默认y位置（你原来设置的是0.5）
                const breathingHeight = 0.02; // 浮动幅度（上下2cm）
                const breathingSpeed = 2; // 呼吸速度（越小越慢，一次呼吸大概3秒）

                body.position.y = baseY + Math.sin(time * breathingSpeed) * breathingHeight;
                // ✨ 头跟随身体呼吸，有弹性
                if (headGroup) {
                    const targetHeadY = body.position.y // 头相对于身体的标准高度
                    headGroup.position.y += (targetHeadY - headGroup.position.y) * 0.05;
                    // 0.05是弹性跟随速度，越小越软
                }
            }

            if (isReturning) {
                const returnSpeed = 0.04; // 控制归零的快慢，越小越慢
                const timeElapsed = (Date.now() - returnStartTime) / returnDuration; // 归零进行到多少了
                const progress = Math.min(timeElapsed, 1);
                const eased = smoothStep(progress);

                targetRotation.groupX *= (1 - eased);
                targetRotation.groupY *= (1 - eased);
                targetRotation.groupZ *= (1 - eased);
                targetRotation.headX *= (1 - eased);
                targetRotation.headY *= (1 - eased);
                targetRotation.headZ *= (1 - eased);

                if (progress >= 1) {
                    isReturning = false; // 归零完成
                }
            }

            if (headGroup) {
                // headGroup围绕body的中心转动（x/y/z）
                headGroup.rotation.x += (targetRotation.groupX - headGroup.rotation.x) * 0.1;
                headGroup.rotation.y += (targetRotation.groupY - headGroup.rotation.y) * 0.1;
                headGroup.rotation.z += (targetRotation.groupZ - headGroup.rotation.z) * 0.1;
            }

            if (head) {
                if (isTickling) {
                    // 震动期间例外直接控制z
                    head.rotation.z = Math.sin((Date.now() - tickleStartTime) * 0.05) * 0.2;
                } else {
                    // head局部动作（以head自己的原点转动）
                    head.rotation.x += (targetRotation.headX - head.rotation.x) * 0.1;
                    head.rotation.y += (targetRotation.headY - head.rotation.y) * 0.1;
                    head.rotation.z += (targetRotation.headZ - head.rotation.z) * 0.1;
                }
            }

            renderer.render(scene, camera);
        }


        // 按钮触发动作
        function triggerAction(type) {
            if (isActionPlaying) return; // 如果正在播放，不允许再次点击

            // 归零
            isReturning = true;
            returnStartTime = Date.now();

            setTimeout(() => {
                // ✨ 等归零一段时间后再开始新动作
                isReturning = false;
                startAction(type);
            }, 500); // 归零时间，比如0.5秒
        }

        function startAction(type) {
            isActionPlaying = true;

            let startTime = Date.now();
            let actionDuration = 3000; // 默认
            if (type === 'greet') {
                actionDuration = 1200;
            } else if (type === 'happy') {
                actionDuration = 1500;
            } else if (type === 'think') {
                actionDuration = 2000;
            } else if (type === 'sad') {
                actionDuration = 3000;
            }


            // 切换表情
            if (facePlane && facePlane.material) {
                if (type === 'greet') {
                    facePlane.material.map = faceTextures.greet;
                    facePlane.scale.set(1.01, 1, 1);
                } else if (type === 'happy') {
                    facePlane.material.map = faceTextures.laugh;
                    facePlane.scale.set(1.5, 1, 1);
                } else {
                    facePlane.material.map = faceTextures.default;
                    facePlane.scale.set(1, 1, 1);
                }
                facePlane.material.needsUpdate = true;
            }
            // 设置不同动作
            function updateAction() {
                const elapsed = (Date.now() - startTime); // 0~1之间
                const progress = elapsed / actionDuration; // 0 ~ 1之间

                if (type === 'greet') {
                    if (progress < 0.5) {
                        // 前一半，头往右偏
                        targetRotation.groupZ = -0.3 * progress * 2; // 0到0.3弧度（大约17度）
                    } else {
                        // 后一半，头慢慢回到正前
                        targetRotation.groupZ = -0.3 * (2 - progress * 2); // 0.3到0
                    }
                    if (progress > 0.95) {
                        if (facePlane) {
                            facePlane.material.map = textureLoader.load('assets/default.png'); // 笑脸图片
                            facePlane.scale.set(1, 1, 1);
                            facePlane.material.needsUpdate = true;
                        }
                    }
                } else if (type === 'happy') {
                    targetRotation.groupZ = 0.3 * Math.sin(progress * Math.PI * 4);
                    if (progress > 0.95) {
                        if (facePlane) {
                            facePlane.material.map = textureLoader.load('assets/default.png'); // 笑脸图片
                            facePlane.scale.set(1, 1, 1);
                            facePlane.material.needsUpdate = true;
                        }
                    }

                } else if (type === 'sad') {
                    if (facePlane && facePlane.scale) {
                        if (progress < 0.25) {
                            // ✨ 0~25%：眼睛放大再回缩
                            const expand = progress < 0.125 ? (progress / 0.125) : (1 - (progress - 0.125) / 0.125);
                            const scaleFactor = 1 + expand * 0.3; // 最多放大到2.5倍
                            facePlane.scale.set(1, 1 * scaleFactor, 1);
                        } else if (progress >= 0.25 && progress < 0.5) {
                            // ✨ 25%~50%：停顿，眼睛恢复正常
                            facePlane.scale.set(1, 1, 1);
                            targetRotation.headX = 0;
                            targetRotation.headY = 0;
                        } else if (progress >= 0.5 && progress < 0.9) {
                            // ✨ 50%~90%：开始慢慢向右下方低头
                            facePlane.scale.set(1, 1, 1);
                            const moveProgress = (progress - 0.5) / 0.4; // 从0到1
                            targetRotation.headX = 0.3 * moveProgress;
                            targetRotation.headY = 0.2 * moveProgress;
                        } else {
                            // ✨ 90%~100%：眨眼
                            const blinkProgress = (progress - 0.9) / 0.1;
                            const scaleY = 1 * (1 - 0.5 * Math.sin(blinkProgress * Math.PI));
                            facePlane.scale.set(1, scaleY, 1);
                        }
                    }
                } else if (type === 'think') {
                    // 头微微歪斜
                    targetRotation.headY = progress * 0.2 * Math.min(elapsed, 1);
                    targetRotation.headX = -0.1 * Math.min(elapsed, 1) * progress;
                }

                if (elapsed < actionDuration) {
                    requestAnimationFrame(updateAction);
                } else {
                    // 动作结束
                    isActionPlaying = false;
                }
            }
            updateAction();
        }

        // 挠痒痒
        function triggerTickle() {
            if (isTickling) return; // 如果正在挠，不要重复挠

            isTickling = true;
            tickleStartTime = Date.now();

            if (laughSound) {
                laughSound.currentTime = 0;
                laughSound.play();
            }

            // 0.8秒后停止挠
            setTimeout(() => {
                isTickling = false;
                // 归零
                if (head) {
                    head.rotation.set(0, 0, 0);
                    head.position.set(0, 0, 0);
                }
            }, 800);
        }

        // 目光跟随
        function onPressStart(event) {
            // 新加：如果点击的是button元素，就不处理
            if (event.target.tagName === 'BUTTON' || event.target.closest('button')) {
                return;
            }
            if (isActionPlaying) return;
            // 更新鼠标坐标（归一化）
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const intersectsBody = raycaster.intersectObject(body, true); // true表示包括子对象
            const intersectsHead = raycaster.intersectObject(headGroup, true);
            if (intersectsBody.length > 0 || intersectsHead.length > 0) {
                // 点到了IP形象（头）
                triggerTickle();
            } else {
                // 没点到，正常进入拖动
                isPressing = true;
                updateHeadDirection(event);
                window.addEventListener('mousemove', updateHeadDirection);
            }
        }

        function onPressEnd(event) {
            isPressing = false;
            window.removeEventListener('mousemove', updateHeadDirection);
        }

        function updateHeadDirection(event) {
            if (!isPressing) return;
            const x = (event.clientX / window.innerWidth) * 2 - 1;
            const y = -(event.clientY / window.innerHeight) * 2 + 1;
            targetRotation.headY = x * 0.3;
            targetRotation.headX = -y * 0.2;
        }
    </script>

</body>

</html>